version: "3.9"

configs:
  nginx_conf:
    file: ./nginx/nginx.conf
  nginx_vhost:
    file: ./nginx/conf/dobong.conf
  maintenance_html:
    file: ./nginx/maintenance.html

networks:
  web:
    driver: overlay

services:
  api:
    image: ${IMAGE_NAME}:${TAG}
    # env_file은 stack deploy 시 클라이언트가 읽어서 값으로 주입됩니다.
    env_file:
      - ../../.env
    networks: [web]
    deploy:
      replicas: 2
      update_config:
        parallelism: 1
        delay: 10s
        order: start-first
        failure_action: rollback
        monitor: 30s
      restart_policy:
        condition: on-failure
    # wget이 이미지에 없을 수 있으니 실패 시 exit 하도록 'CMD-SHELL' + 보호구문 권장
    healthcheck:
      test: ["CMD-SHELL", "wget -qO- http://localhost:8080/actuator/health >/dev/null 2>&1 || exit 1"]
      interval: 10s
      timeout: 3s
      retries: 6

  nginx:
    image: nginx:1.27-alpine
    networks: [web]
    ports:
      - target: 80
        published: 80
        protocol: tcp
        mode: ingress
    deploy:
      replicas: 1
      restart_policy:
        condition: any
    configs:
      - source: nginx_conf
        target: /etc/nginx/nginx.conf
        mode: 0444
      - source: nginx_vhost
        target: /etc/nginx/conf.d/dobong.conf
        mode: 0444
      - source: maintenance_html
        target: /usr/share/nginx/html/maintenance.html
        mode: 0444
